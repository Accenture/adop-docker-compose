# set TARGET_HOST to dns/ip of proxy
# set LOGSTASH_HOST to dns/ip of logstash host

proxy:
  container_name: proxy
  restart: always
  image: accenture/adop-nginx:0.1.0
  #build: ../images/docker-nginx/
  net: ${CUSTOM_NETWORK_NAME}
  ports:
    - "80:80"
    - "443:443"
  log_driver: "syslog"
  log_opt:
    syslog-address: "udp://${LOGSTASH_HOST}:25826"
    syslog-tag: "proxy"

ldap:
  container_name: ldap
  restart: always
  #build: ../images/docker-ldap/
  image: accenture/adop-ldap:0.1.0
  net: ${CUSTOM_NETWORK_NAME}
  expose:
    - "389"
  environment:
    LDAP_ADMIN_PASSWORD: "***REMOVED***"
    LDAP_LOG_LEVEL: 0
  log_driver: "syslog"
  log_opt:
    syslog-address: "udp://${LOGSTASH_HOST}:25826"
    syslog-tag: "ldap"

gerrit-mysql:
  container_name: gerrit-mysql
  restart: always
  image: mysql:5.6.25
  net: ${CUSTOM_NETWORK_NAME}
  expose:
    - "3306"
  environment:
    MYSQL_ROOT_PASSWORD: "***REMOVED***"
    MYSQL_USER: "gerrit"
    MYSQL_PASSWORD: "***REMOVED***"
    MYSQL_DATABASE: "gerrit"
    #SERVICE_3306_NAME: gerrit-mysql
  log_driver: "syslog"
  log_opt:
    syslog-address: "udp://${LOGSTASH_HOST}:25826"
    syslog-tag: "gerrit-mysql"

gerrit:
  container_name: gerrit
  restart: always
  #build: ../images/docker-gerrit/
  image: accenture/adop-gerrit:0.1.0
  net: ${CUSTOM_NETWORK_NAME}
  expose:
    - "8080"
    - "29418"
  environment:
    SERVICE_8080_CHECK_SCRIPT: "curl --silent --fail ${TARGET_HOST}:8030/gerrit"
    SERVICE_8080_NAME: "gerrit"
    SERVICE_29418_NAME: "gerrit-ssh"
    REPO_PATH: "/var/git/repos"
    WEBURL: "http://${TARGET_HOST}/gerrit"
    DATABASE_TYPE: "mysql"
    DB_HOSTNAME: "gerrit-mysql"
    DB_PORT: "3306"
    DB_NAME: "gerrit"
    DB_USER: "gerrit"
    DB_PASSWORD:  "***REMOVED***"
    AUTH_LOGOUTURL: "http://${TARGET_HOST}/gerrit"
    AUTH_TYPE: "LDAP"
    LDAP_SERVER: "ldap:389"
    LDAP_ACCOUNTBASE: "dc=adop,dc=accenture,dc=com"
    LDAP_ACCOUNTPATTERN: "(cn=$${username})"
    LDAP_ACCOUNTFULLNAME: "$${cn}"
    LDAP_ACCOUNTEMAILADDRESS: "mail"
    LDAP_USERNAME: "cn=admin,dc=adop,dc=accenture,dc=com"
    LDAP_PASSWORD: "***REMOVED***"
    LDAP_GROUPBASE: "ou=groups,dc=adop,dc=accenture,dc=com"
    LDAP_GROUPPATTERN: "(cn=$${groupname})"
    LDAP_GROUPMEMBERPATTERN: "(uniqueMember=$${dn})"
    HTTPD_LISTENURL: "proxy-http://0.0.0.0:8080/gerrit"
    USER_NAME: "Gerrit Code Review" 
    USER_EMAIL: "gerrit@adop" 
    DOWNLOAD_SCHEME: "http"
  log_driver: "syslog"
  log_opt:
    syslog-address: "udp://${LOGSTASH_HOST}:25826"
    syslog-tag: "gerrit"

sensu-uchiwa:
  container_name: sensu-uchiwa
  restart: always
  image: sstarcher/uchiwa
  net: ${CUSTOM_NETWORK_NAME}
  environment:
    SENSU_HOSTNAME: sensu-api
  expose:
    - "3000"

sensu-api:
  container_name: sensu-api
  restart: always
  image: accenture/adop-sensu:0.1.0
  net: ${CUSTOM_NETWORK_NAME}
  command: api
  expose:
    - "4567"
  environment:
    RABBITMQ_HOST: sensu-rabbitmq
    REDIS_HOST: sensu-redis

sensu-server:
  container_name: sensu-server
  restart: always
  image: accenture/adop-sensu:0.1.0
  net: ${CUSTOM_NETWORK_NAME}
  command: server
  environment:
    CLIENT_NAME: core
    API_HOST: sensu-api
    RABBITMQ_HOST: sensu-rabbitmq
    REDIS_HOST: sensu-redis

sensu-client:
  container_name: sensu-client
  restart: always
  image: accenture/adop-sensu:0.1.0
  net: ${CUSTOM_NETWORK_NAME}
  command: client
  environment:
    CLIENT_NAME: core
    RABBITMQ_HOST: sensu-rabbitmq
    JENKINS_PREFIX: jenkins
    CLIENT_SUBSCRIPTIONS: "proxy,gerrit,jenkins,nexus,sonarqube,sensu,kibana"

sensu-rabbitmq:
  container_name: sensu-rabbitmq
  restart: always
  image: rabbitmq:3.5.7-management
  net: ${CUSTOM_NETWORK_NAME}
  expose:
    - "5672"
    - "5671"
    - "15672"
    - "15671"

sensu-redis:
  container_name: sensu-redis
  restart: always
  image: redis:3.0.7
  net: ${CUSTOM_NETWORK_NAME}
  expose:
    - "6379"

sonar-mysql:
  container_name: sonar-mysql
  restart: always
  image: mysql:5.6.25
  net: ${CUSTOM_NETWORK_NAME}
  expose:
    - "3306"
  environment: 
    SERVICE_3306_NAME: "sonar-mysql"
    MYSQL_ROOT_PASSWORD: "***REMOVED***"
    MYSQL_USER: "sonar"
    MYSQL_PASSWORD: "***REMOVED***"
    MYSQL_DATABASE: "sonar"
  log_driver: "syslog"
  log_opt:
    syslog-address: "udp://${LOGSTASH_HOST}:25826"
    syslog-tag: "sonar-mysql"

sonar:
  container_name: sonar
  restart: always
  image: accenture/adop-sonar:0.1.0
  #build: ../images/docker-sonar/
  net: ${CUSTOM_NETWORK_NAME}
  expose:
    - "9000"
  environment:
    SERVICE_9000_NAME: "sonar"
    SERVICE_9000_CHECK_SCRIPT: "curl --silent --fail ${TARGET_HOST}:8020/sonar"  
    LDAP_URL: "ldap://ldap:389"
    LDAP_BIND_DN: "cn=admin,dc=adop,dc=accenture,dc=com"
    LDAP_BIND_PASSWORD: "***REMOVED***"
    LDAP_USER_BASE_DN: "ou=people,dc=adop,dc=accenture,dc=com" 
    LDAP_USER_REQUEST: "(&(objectClass=inetOrgPerson)(uid={login}))" 
    LDAP_USER_REAL_NAME_ATTRIBUTE: "displayName"
    LDAP_USER_EMAIL_ATTRIBUTE: "mail"
    LDAP_GROUP_BASE_DN: "ou=groups,dc=adop,dc=accenture,dc=com" 
    LDAP_GROUP_REQUEST: "(&(objectClass=groupOfUniqueNames)(uniqueMember={dn}))" 
    LDAP_GROUP_ID_ATTRIBUTE: "cn"
    SONARQUBE_JDBC_URL: "jdbc:mysql://sonar-mysql:3306/sonar?useUnicode=true&characterEncoding=utf8&rewriteBatchedStatements=true"
  log_driver: "syslog"
  log_opt:
    syslog-address: "udp://${LOGSTASH_HOST}:25826"
    syslog-tag: "sonar"

jenkins:
  container_name: jenkins
  restart: always
  image: accenture/adop-jenkins:0.1.0
  #build: ../images/docker-jenkins/
  net: ${CUSTOM_NETWORK_NAME}
  expose:
    - "8080"
    - "50000"
  privileged: true
  environment:
    SERVICE_CHECK_SCRIPT: "curl --silent --fail ${TARGET_HOST}:8010/jenkins"
    SERVICE_8080_NAME: "jenkins"
    JENKINS_OPTS: "--prefix=/jenkins"
    ROOT_URL: "http://proxy/jenkins/"
    LDAP_SERVER: "ldap:389"
    LDAP_ROOTDN: "dc=adop,dc=accenture,dc=com"
    LDAP_USER_SEARCH_BASE: "ou=people"
    LDAP_USER_SEARCH: "uid={0}"
    LDAP_GROUP_SEARCH_BASE: "ou=groups"
    LDAP_GROUP_SEARCH_FILTER: ""
    LDAP_GROUP_MEMBERSHIP_FILTER: ""
    LDAP_MANAGER_DN: "cn=admin,dc=adop,dc=accenture,dc=com"
    LDAP_MANAGER_PASSWORD: "***REMOVED***"
    LDAP_INHIBIT_INFER_ROOTDN: "false"
    LDAP_DISABLE_MAIL_ADDRESS_RESOLVER: "false"
    LDAP_DISPLAY_NAME_ATTRIBUTE_NAME: "displayName"
    LDAP_MAIL_ADDRESS_ATTRIBUTE_NAME: "mail"
    GERRIT_HOST_NAME: "gerrit"
    GERRIT_FRONT_END_URL: "http://gerrit/gerrit"
    SONAR_SERVER_URL: "http://sonar:9000/sonar/"
    SONAR_ACCOUNT_LOGIN: "jenkins"
    SONAR_ACCOUNT_PASSWORD: "***REMOVED***"
    SONAR_DB_URL: "jdbc:mysql://sonar-mysql:3306/sonar?useUnicode=true&amp;characterEncoding=utf8"
    SONAR_DB_LOGIN: "sonar"
    SONAR_DB_PASSWORD: "***REMOVED***"
    SONAR_PLUGIN_VERSION: ""
    SONAR_ADDITIONAL_PROPS: ""
    SONAR_RUNNER_VERSION: "2.4"
    ANT_VERSION: "1.9.4"
    MAVEN_VERSION: "3.0.5"
    NODEJS_VERSION: "0.12.2"
    NODEJS_GLOBAL_PACKAGES: "grunt-cli@~0.1.13 bower@~1.3.12 plato@~1.2.1"
    NODEJS_PACKAGES_REFRESH_HOURS: "72"
    GIT_GLOBAL_CONFIG_NAME: "ADOP Jenkins"
    GIT_GLOBAL_CONFIG_EMAIL: "jenkins@adop.accenture.com"
    
jenkins-slave:
  container_name: jenkins-slave
  restart: always
  image: accenture/adop-jenkins-slave:0.1.0
  net: ${CUSTOM_NETWORK_NAME}
  volumes:
    - /var/run/docker.sock:/var/run/docker.sock
  privileged: true
  log_driver: "syslog"
  log_opt:
    syslog-address: "udp://${LOGSTASH_HOST}:25826"
    syslog-tag: "jenkins-slave"

selenium-hub:
  container_name: selenium-hub
  restart: always
  image: selenium/hub:2.46.0
  net: ${CUSTOM_NETWORK_NAME}
  expose:
    - "4444"
  environment:
    SERVICE_4444_CHECK_SCRIPT: "curl --silent --fail ${TARGET_HOST}:4444/grid/console"
  log_driver: "syslog"
  log_opt:
    syslog-address: "udp://${LOGSTASH_HOST}:25826"
    syslog-tag: "selenium-hub"

selenium-node-chrome:
  container_name: selenium-node-chrome
  restart: always
  image: selenium/node-chrome:2.46.0
  net: ${CUSTOM_NETWORK_NAME}
  environment:
    SE_OPTS: "-nodeConfig /var/selenium-config/config-chrome.json"
    HUB_PORT_4444_TCP_ADDR: "selenium-hub"
    HUB_PORT_4444_TCP_PORT: "4444"
  log_driver: "syslog"
  log_opt:
    syslog-address: "udp://${LOGSTASH_HOST}:25826"
    syslog-tag: "selenium-node-chrome"

selenium-node-firefox:
  container_name: selenium-node-firefox
  restart: always
  image: selenium/node-firefox:2.46.0
  net: ${CUSTOM_NETWORK_NAME}
  environment:
    SE_OPTS: "-nodeConfig /var/selenium-config/config-firefox.json"
    HUB_PORT_4444_TCP_ADDR: "selenium-hub"
    HUB_PORT_4444_TCP_PORT: "4444"
  log_driver: "syslog"
  log_opt:
    syslog-address: "udp://${LOGSTASH_HOST}:25826"
    syslog-tag: "selenium-node-firefox"

elasticsearch:
  container_name: elasticsearch
  restart: always
  image: elasticsearch:2.1.1
  net: ${CUSTOM_NETWORK_NAME}
  command: elasticsearch -Des.network.host=0.0.0.0
  ports:
    - "9200:9200"
  log_driver: "syslog"
  log_opt:
    syslog-address: "udp://${LOGSTASH_HOST}:25826"
    syslog-tag: "elasticsearch"

logstash:
  container_name: logstash
  restart: always
  image: docker.accenture.com/adop/logstash:0.0.1
  net: ${CUSTOM_NETWORK_NAME}
  environment:
    - LS_HEAP_SIZE=1024m
  ports:
    - "12201:12201/udp"
    - "25826:25826/udp"
    - "5000:5000/tcp"
  log_driver: "syslog"
  log_opt:
    syslog-address: "udp://${LOGSTASH_HOST}:25826"
    syslog-tag: "logstash"

kibana:
  container_name: kibana
  restart: always
  image: kibana:4.3.1
  net: ${CUSTOM_NETWORK_NAME}
  command: kibana
  environment:
    - ELASTICSEARCH_URL=http://elasticsearch:9200
  ports:
    - "5601:5601"
  log_driver: "syslog"
  log_opt:
    syslog-address: "udp://${LOGSTASH_HOST}:25826"
    syslog-tag: "kibana"

nexus:
  container_name: nexus
  restart: always
  image:  accenture/adop-nexus:0.1.0
  net: ${CUSTOM_NETWORK_NAME}
  expose:
    - "8081"
  environment:
    SERVICE_CHECK_SCRIPT: "curl --silent --fail ${TARGET_HOST}:80/"
    SERVICE_8081_NAME: "nexus"
    NEXUS_BASE_URL: "http://${TARGET_HOST}/nexus"
    LDAP_SEARCH_BASE: "dc=adop,dc=accenture,dc=com"
    ADOP_LDAP_ENABLED: "true"
    LDAP_URL: "ldap"
    LDAP_BIND_DN: "cn=admin,dc=adop,dc=accenture,dc=com"
    LDAP_USER_PASSWORD_ATTRIBUTE: "userPassword"
    LDAP_USER_BASE_DN: "ou=people"
    LDAP_GROUP_BASE_DN: "ou=groups"
    LDAP_BIND_PASSWORD: "***REMOVED***"
  log_driver: "syslog"
  log_opt:
    syslog-address: "udp://${LOGSTASH_HOST}:25826"
    syslog-tag: "nexus"
